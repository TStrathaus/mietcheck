"use strict";(()=>{var e={};e.id=2272,e.ids=[2272],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},61212:e=>{e.exports=require("async_hooks")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},85807:e=>{e.exports=require("module")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},86624:e=>{e.exports=require("querystring")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},63757:e=>{e.exports=import("prettier/plugins/html")},45747:e=>{e.exports=import("prettier/standalone")},84492:e=>{e.exports=require("node:stream")},35738:(e,t,n)=>{n.a(e,async(e,r)=>{try{n.r(t),n.d(t,{originalPathname:()=>x,patchFetch:()=>c,requestAsyncStorage:()=>d,routeModule:()=>u,serverHooks:()=>m,staticGenerationAsyncStorage:()=>h});var s=n(49303),i=n(88716),a=n(60670),o=n(34747),l=e([o]);o=(l.then?(await l)():l)[0];let u=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/send-letter-email/route",pathname:"/api/send-letter-email",filename:"route",bundlePath:"app/api/send-letter-email/route"},resolvedPagePath:"D:\\STTH\\2026 KI\\mietcheck\\src\\app\\api\\send-letter-email\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:d,staticGenerationAsyncStorage:h,serverHooks:m}=u,x="/api/send-letter-email/route";function c(){return(0,a.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:h})}r()}catch(e){r(e)}})},53797:(e,t)=>{t.Z=function(e){return{id:"credentials",name:"Credentials",type:"credentials",credentials:{},authorize:()=>null,options:e}}},34747:(e,t,n)=>{n.a(e,async(e,r)=>{try{n.r(t),n.d(t,{POST:()=>d});var s=n(87070),i=n(75571),a=n(95456),o=n(92274),l=n(15886),c=n(98586),u=e([o]);async function d(e){try{let t=await (0,i.getServerSession)(a.L);if(!t?.user?.email)return s.NextResponse.json({success:!1,error:"Unauthorized - Please log in"},{status:401});let{tenantName:n,tenantAddress:r,tenantCity:u,propertyAddress:d,netRent:h,referenceRate:m,contractDate:x,landlordName:g,landlordAddress:p,landlordCity:f}=await e.json();if(!n||!d||!h||!g)return s.NextResponse.json({success:!1,error:"Alle Pflichtfelder m\xfcssen ausgef\xfcllt werden"},{status:400});let F=(0,c.b1)({currentRent:parseFloat(h),currentReferenceRate:parseFloat(m),newReferenceRate:(0,c.KT)(),contractDate:new Date(x)}),z=function(){let e=new Date,t=e.getFullYear();e.getMonth();let n=[new Date(t,2,31),new Date(t,5,30),new Date(t,8,30),new Date(t,11,31)],r=new Date(e);for(let e of(r.setMonth(r.getMonth()+3),n))if(e>r)return e.toLocaleDateString("de-CH",{year:"numeric",month:"long",day:"numeric"});return new Date(t+1,2,31).toLocaleDateString("de-CH",{year:"numeric",month:"long",day:"numeric"})}(),b={tenant:{name:n,address:r,city:u},landlord:{name:g,address:p,city:f},contract:{address:d,contractDate:x,currentRent:parseFloat(h),referenceRate:parseFloat(m)},calculation:{newRent:F.newRent,netReduction:F.netReduction,yearlySavings:F.yearlySavings},nextTerminationDate:z};console.log("\uD83D\uDCC4 Generating PDF for email...");let R=(0,l.p)(b);console.log("\uD83D\uDCE7 Sending email to:",t.user.email);let w=await (0,o.dS)({to:t.user.email,userName:t.user.name||n,address:d,monthlyReduction:F.netReduction,pdfBuffer:Buffer.from(R),pdfFilename:`herabsetzungsbegehren_${d.replace(/[^a-zA-Z0-9]/g,"_")}.pdf`});if(!w.success)return s.NextResponse.json({success:!1,error:w.error||"Failed to send email"},{status:500});return console.log("✅ Letter email sent successfully"),s.NextResponse.json({success:!0,message:"Brief wurde erfolgreich per E-Mail versendet"})}catch(e){return console.error("❌ Send letter email error:",e),s.NextResponse.json({success:!1,error:e.message||"Failed to send email"},{status:500})}}o=(u.then?(await u)():u)[0],r()}catch(e){r(e)}})},95456:(e,t,n)=>{n.d(t,{L:()=>o});var r=n(53797),s=n(42023),i=n.n(s),a=n(86923);let o={providers:[(0,r.Z)({name:"Credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;try{let t=(await (0,a.i6)`
            SELECT id, email, password_hash, name
            FROM users
            WHERE email = ${e.email.toLowerCase().trim()}
          `).rows[0];if(!t||!await i().compare(e.password,t.password_hash))return null;return console.log("✅ Login successful for:",t.email),{id:t.id.toString(),email:t.email,name:t.name}}catch(e){return console.error("❌ Auth error:",e),null}}})],pages:{signIn:"/login",signOut:"/login",error:"/login"},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id),e),session:async({session:e,token:t})=>(e.user&&(e.user.id=t.id),e)},session:{strategy:"jwt",maxAge:2592e3},secret:process.env.NEXTAUTH_SECRET}},98586:(e,t,n)=>{function r(e){let{currentRent:t,currentReferenceRate:n,newReferenceRate:r,contractDate:s}=e,i=n-r,a=0;.25===i?a=2.91:.5===i?a=5.82:.75===i&&(a=8.73);let o=a/100*t,l=(new Date().getTime()-s.getTime())/31536e6,c=Math.min(2*l,5),u=c/100*t*.4,d=.5*l/100*t,h=Math.max(0,o-u-d),m=t-h,x=12*h,g=[`Basis-Reduktion bei ${i}% Zinssenkung: ${a.toFixed(2)}%`,`Brutto-Reduktion: CHF ${o.toFixed(2)}`,`Abz\xfcglich 40% Teuerung (${c.toFixed(1)}%): CHF ${u.toFixed(2)}`,`Abz\xfcglich allgemeine Kostensteigerung: CHF ${d.toFixed(2)}`,`Netto-Reduktion pro Monat: CHF ${h.toFixed(2)}`,`Neue Nettomiete: CHF ${m.toFixed(2)}`,`J\xe4hrliche Ersparnis: CHF ${x.toFixed(2)}`];return{reductionPercentage:a,grossReduction:Math.round(100*o)/100,inflationOffset:Math.round(100*u)/100,costIncreaseOffset:Math.round(100*d)/100,netReduction:Math.round(100*h)/100,newRent:Math.round(100*m)/100,yearlySavings:Math.round(100*x)/100,details:g}}function s(){return 1.25}n.d(t,{KT:()=>s,b1:()=>r})},15886:(e,t,n)=>{n.d(t,{p:()=>i});var r=n(51933);let s=[{datum:"02.09.2025",satz:1.25},{datum:"03.03.2025",satz:1.5},{datum:"01.12.2023",satz:1.75},{datum:"01.06.2023",satz:1.5},{datum:"01.12.2022",satz:1.25}];function i(e){let t=new r.ZP({orientation:"portrait",unit:"mm",format:"a4"}),n=20;t.setFontSize(10),t.setFont("helvetica","normal"),t.text(e.tenant.name,25,n),n+=5,t.text(e.tenant.address,25,n),n+=5,t.text(e.tenant.city,25,n),n+=20,t.text(e.landlord.name,120,n),n+=5,t.text(e.landlord.address,120,n),n+=5,t.text(e.landlord.city,120,n),n+=20,t.setFont("helvetica","bold"),t.text("Per Einschreiben (A-Post Plus)",25,n),t.setFont("helvetica","normal"),n+=15;let i=new Date().toLocaleDateString("de-CH",{year:"numeric",month:"long",day:"numeric"});for(let r of(t.text(`${e.tenant.city.split(" ").slice(1).join(" ")}, ${i}`,25,n),n+=15,t.setFontSize(11),t.setFont("helvetica","bold"),t.text("Betreff: Herabsetzungsbegehren gem\xe4ss Art. 270a OR",25,n),n+=5,t.setFontSize(10),t.setFont("helvetica","normal"),t.text(`Mietobjekt: ${e.contract.address}`,25,n),n+=12,t.text("Sehr geehrte Damen und Herren",25,n),n+=10,[`Gest\xfctzt auf Art. 270a OR und Art. 13 VMWG beantrage ich hiermit die Herabsetzung des Nettomietzinses f\xfcr die oben genannte Wohnung.`,"","1. Ausgangslage",`Bei Abschluss des Mietvertrages vom ${function(e){try{return new Date(e).toLocaleDateString("de-CH",{year:"numeric",month:"long",day:"numeric"})}catch{return e}}(e.contract.contractDate)} betrug der hypothekarische Referenzzinssatz ${e.contract.referenceRate}%. Das Bundesamt f\xfcr Wohnungswesen (BWO) hat den Referenzzinssatz per 02. September 2025 auf 1.25% gesenkt.`,"","2. Rechtliche Grundlage",`Gem\xe4ss Art. 13 Abs. 1 VMWG berechtigt eine Senkung des Referenzzinssatzes um 0.25 Prozentpunkte zu einer Mietzinsreduktion von 2.91% des Nettomietzinses (bei einem Zinssatz unter 5%).`])){if(n>260&&(t.addPage(),n=20),""===r){n+=3;continue}r.startsWith("1.")||r.startsWith("2.")||r.startsWith("3.")||r.startsWith("4.")?t.setFont("helvetica","bold"):t.setFont("helvetica","normal");let e=t.splitTextToSize(r,165);t.text(e,25,n),n+=5*e.length}(n+=5)>220&&(t.addPage(),n=20),t.setFont("helvetica","bold"),t.text("3. Berechnung",25,n),n+=7,t.setDrawColor(200,200,200),t.setFillColor(248,248,248),t.roundedRect(25,n,165,45,2,2,"FD"),n+=6,t.setFont("helvetica","normal"),t.setFontSize(9);let a=Math.round((e.contract.referenceRate-1.25)/.25),o=2.91*a;for(let r of[`Referenzzinssatz bei Vertragsabschluss: ${e.contract.referenceRate}%`,"Aktueller Referenzzinssatz (seit 02.09.2025): 1.25%",`Zinssenkung: ${(e.contract.referenceRate-1.25).toFixed(2)}% (${a} \xd7 0.25%)`,`Mietzinsreduktion: ${a} \xd7 2.91% = ${o.toFixed(2)}%`,"",`Aktueller Nettomietzins: CHF ${e.contract.currentRent.toFixed(2)}`,`Reduktion: CHF ${e.calculation.netReduction.toFixed(2)} (${o.toFixed(2)}%)`,`Neuer Nettomietzins: CHF ${e.calculation.newRent.toFixed(2)}`]){if(""===r){n+=2;continue}t.text(r,30,n),n+=4.5}for(let r of(n+=10,t.setFontSize(10),t.setFont("helvetica","bold"),t.text("4. Antrag",25,n),n+=7,t.setFont("helvetica","normal"),[`Ich beantrage hiermit die Herabsetzung des monatlichen Nettomietzinses von CHF ${e.contract.currentRent.toFixed(2)} auf CHF ${e.calculation.newRent.toFixed(2)} per ${e.nextTerminationDate}.`,"",`Dies entspricht einer j\xe4hrlichen Ersparnis von CHF ${e.calculation.yearlySavings.toFixed(2)}.`,"",`Ich bitte Sie, mir die Herabsetzung innert 30 Tagen schriftlich auf dem amtlichen Formular zu best\xe4tigen.`,"",`Sollten Sie meinem Begehren nicht entsprechen oder innert dieser Frist nicht antworten, werde ich mich gem\xe4ss Art. 270b OR an die zust\xe4ndige Schlichtungsbeh\xf6rde wenden.`])){if(n>260&&(t.addPage(),n=20),""===r){n+=3;continue}let e=t.splitTextToSize(r,165);t.text(e,25,n),n+=5*e.length}for(let r of(n+=10,t.text("Freundliche Gr\xfcsse",25,n),n+=20,t.setDrawColor(150,150,150),t.line(25,n,85,n),n+=5,t.setFontSize(9),t.text(e.tenant.name,25,n),n+=4,t.text("(Handschriftliche Unterschrift)",25,n),n+=15,t.setFontSize(10),t.setFont("helvetica","bold"),t.text("Beilagen:",25,n),n+=5,t.setFont("helvetica","normal"),t.setFontSize(9),t.text("- Kopie des Mietvertrages (empfohlen)",25,n),n+=4,t.text("- Referenzzinssatz-Bekanntmachung BWO (empfohlen)",25,n),t.addPage(),n=20,t.setFontSize(14),t.setFont("helvetica","bold"),t.text("Beilage: Referenzzinssatz-Historie und Versandanleitung",25,n),n+=15,t.setFontSize(11),t.text("Hypothekarischer Referenzzinssatz (BWO)",25,n),n+=8,t.setFillColor(240,240,240),t.rect(25,n,80,7,"F"),t.setFontSize(9),t.setFont("helvetica","bold"),t.text("G\xfcltig ab",30,n+5),t.text("Referenzzinssatz",70,n+5),n+=7,t.setFont("helvetica","normal"),s))1.25===r.satz&&"02.09.2025"===r.datum&&(t.setFillColor(220,252,231),t.rect(25,n,80,6,"F")),t.text(r.datum,30,n+4),t.text(`${r.satz.toFixed(2)}%`,70,n+4),n+=6;for(let e of(t.setFontSize(8),t.setTextColor(100,100,100),t.text("Quelle: Bundesamt f\xfcr Wohnungswesen (BWO)",25,n+5),t.setTextColor(0,0,0),n+=20,t.setFontSize(11),t.setFont("helvetica","bold"),t.text("Versandanleitung",25,n),n+=10,t.setFontSize(10),t.setFont("helvetica","normal"),["1. Brief ausdrucken","   Drucken Sie dieses Dokument auf weissem A4-Papier aus.","","2. Handschriftlich unterschreiben","   Unterschreiben Sie den Brief im vorgesehenen Feld mit Kugelschreiber.","","3. Per Einschreiben versenden (A-Post Plus)","   Senden Sie den Brief als Einschreiben an Ihren Vermieter.","   Wichtig: Bewahren Sie den Einlieferungsbeleg auf!","","4. Frist abwarten","   Der Vermieter hat 30 Tage Zeit, Ihnen auf dem amtlichen Formular","   zu antworten.","","5. Bei Ablehnung oder Nichtantwort","   Wenden Sie sich an die Schlichtungsbeh\xf6rde Ihres Bezirks.","   Das Verfahren ist in der Regel kostenlos."])){if(""===e){n+=3;continue}e.match(/^\d\./)?t.setFont("helvetica","bold"):t.setFont("helvetica","normal"),t.text(e,25,n),n+=5}n+=10,t.setFillColor(254,243,199),t.roundedRect(25,n,165,25,2,2,"F"),n+=6,t.setFont("helvetica","bold"),t.setFontSize(9),t.text("Wichtiger Hinweis:",30,n),n+=5,t.setFont("helvetica","normal");let l=t.splitTextToSize("Dieses Dokument wurde automatisch erstellt und ersetzt keine Rechtsberatung. Bei komplexen F\xe4llen oder Unsicherheiten empfehlen wir die Konsultation eines Mieterschutzverbandes oder einer Rechtsberatung.",155);return t.text(l,30,n),n=282,t.setFontSize(8),t.setTextColor(150,150,150),t.text("Erstellt mit MietCheck.ch - Ihr Helfer f\xfcr faire Mieten",25,n),t.text(`Generiert am: ${i}`,140,n),new Uint8Array(t.output("arraybuffer"))}}};var t=require("../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),r=t.X(0,[8948,1615,5972,6923,5571,2023,3752,1933,2752],()=>n(35738));module.exports=r})();