"use strict";(()=>{var e={};e.id=416,e.ids=[416],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},29773:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>p,patchFetch:()=>m,requestAsyncStorage:()=>h,routeModule:()=>g,serverHooks:()=>f,staticGenerationAsyncStorage:()=>d});var r={};n.r(r),n.d(r,{POST:()=>c});var a=n(49303),s=n(88716),o=n(60670),i=n(87070),u=n(64937),l=n(67297);async function c(e){try{let t;let{blobUrl:n,fileType:r}=await e.json();if(!n)return i.NextResponse.json({error:"Blob URL fehlt"},{status:400});if(!r)return i.NextResponse.json({error:"File type fehlt"},{status:400});let a=process.env.GEMINI_API_KEY;if(!a)return i.NextResponse.json({error:"GEMINI_API_KEY nicht konfiguriert"},{status:500});if(console.log("\uD83D\uDCC4 Analyzing rent adjustment document:",{blobUrl:n,fileType:r}),(0,l.TI)(r))console.log("\uD83D\uDCD1 Extracting from PDF..."),t=await (0,u.C)(n);else{if(!(0,l.DW)(r))return i.NextResponse.json({error:`Nicht unterst\xfctzter Dateityp: ${r}`},{status:400});console.log("\uD83D\uDDBC️ Extracting from Image with OCR..."),t=await (0,l.oI)(n,r)}if(!t||0===t.trim().length)return i.NextResponse.json({error:"Kein Text konnte extrahiert werden"},{status:400});console.log("\uD83D\uDCC4 Text extracted, length:",t.length);let s=`https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=${a}`,o=`Analysiere dieses Schweizer Mietanpassungs-Dokument und extrahiere folgende Informationen im JSON-Format:

DOKUMENT TEXT:
${t}

Extrahiere:
1. datum: Datum der Mietanpassung im Format YYYY-MM-DD (wann tritt die neue Miete in Kraft?)
2. alteMiete: Bisherige Nettomiete in CHF (nur Zahl, ohne CHF)
3. neueMiete: Neue Nettomiete in CHF (nur Zahl, ohne CHF)
4. alterReferenzzinssatz: Bisheriger Referenzzinssatz in Prozent (z.B. 1.25 f\xfcr 1.25%)
5. neuerReferenzzinssatz: Neuer Referenzzinssatz in Prozent (z.B. 1.50 f\xfcr 1.50%)
6. begruendung: Kurze Begr\xfcndung der Anpassung (max 200 Zeichen)
7. typ: "erh\xf6hung" oder "reduzierung"
8. zusaetzlicheGruende: Array mit weiteren Gr\xfcnden falls vorhanden (z.B. ["Teuerung", "Kostensteigerung", "Wertvermehrung"])

WICHTIG:
- Wenn mehrere Gr\xfcnde genannt werden (z.B. Referenzzinssatz UND Teuerung), liste alle in zusaetzlicheGruende
- Berechne den Typ basierend auf neueMiete vs. alteMiete
- Datum im Format YYYY-MM-DD

Antworte NUR mit einem JSON-Objekt, keine zus\xe4tzlichen Erkl\xe4rungen:

{
  "datum": "YYYY-MM-DD",
  "alteMiete": 0,
  "neueMiete": 0,
  "alterReferenzzinssatz": 0,
  "neuerReferenzzinssatz": 0,
  "begruendung": "...",
  "typ": "erh\xf6hung",
  "zusaetzlicheGruende": []
}`,c=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:o}]}],generationConfig:{temperature:.2,maxOutputTokens:2048}})});if(!c.ok){let e=await c.text();throw Error(`Gemini API Error ${c.status}: ${e}`)}let g=await c.json(),h=g.candidates?.[0]?.content?.parts?.[0]?.text;if(!h)throw Error("Keine Response von Gemini erhalten");console.log("\uD83D\uDCE5 Gemini response:",h.substring(0,200));let d=h.trim();d.startsWith("```json")?d=d.replace(/```json\n?/g,"").replace(/```\n?/g,""):d.startsWith("```")&&(d=d.replace(/```\n?/g,""));let f=JSON.parse(d),p={datum:f.datum||"",alteMiete:parseFloat(f.alteMiete)||0,neueMiete:parseFloat(f.neueMiete)||0,alterReferenzzinssatz:parseFloat(f.alterReferenzzinssatz)||0,neuerReferenzzinssatz:parseFloat(f.neuerReferenzzinssatz)||0,begruendung:f.begruendung||"",typ:f.typ||"erh\xf6hung",zusaetzlicheGruende:f.zusaetzlicheGruende||[]};return console.log("✅ Analysis successful:",p),i.NextResponse.json({success:!0,data:p})}catch(e){return console.error("❌ Analyze anpassung error:",e),i.NextResponse.json({error:"Analyse fehlgeschlagen: "+e.message},{status:500})}}let g=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/analyze-anpassung/route",pathname:"/api/analyze-anpassung",filename:"route",bundlePath:"app/api/analyze-anpassung/route"},resolvedPagePath:"D:\\STTH\\2026 KI\\mietcheck\\src\\app\\api\\analyze-anpassung\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:h,staticGenerationAsyncStorage:d,serverHooks:f}=g,p="/api/analyze-anpassung/route";function m(){return(0,o.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:d})}},67297:(e,t,n)=>{async function r(e,t){let n=process.env.GEMINI_API_KEY;if(!n)throw Error("GEMINI_API_KEY nicht konfiguriert");console.log("\uD83D\uDDBC️ Extracting text from image using Gemini Vision..."),console.log("\uD83D\uDCF7 Image URL:",e),console.log("\uD83D\uDCCB MIME type:",t);try{let r=await fetch(e);if(!r.ok)throw Error(`Failed to fetch image: ${r.status}`);let a=await r.arrayBuffer(),s=Buffer.from(a).toString("base64");console.log("✅ Image downloaded, size:",a.byteLength,"bytes");let o=`https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=${n}`,i=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{inline_data:{mime_type:t,data:s}},{text:"Extract all text from this image. Include all visible text, numbers, dates, and addresses. Return only the extracted text without any additional commentary or explanations."}]}],generationConfig:{temperature:.1,maxOutputTokens:4096}})});if(!i.ok){let e=await i.text();throw Error(`Gemini Vision API Error ${i.status}: ${e}`)}let u=await i.json(),l=u.candidates?.[0]?.content?.parts?.[0]?.text;if(!l)throw Error("Keine Text-Extraktion von Gemini erhalten");return console.log("✅ Text extracted successfully, length:",l.length),console.log("\uD83D\uDCC4 First 200 chars:",l.substring(0,200)),l}catch(e){throw console.error("❌ Image OCR error:",e),Error(`Image-Texterkennung fehlgeschlagen: ${e.message}`)}}function a(e){return e.startsWith("image/")}function s(e){return"application/pdf"===e}n.d(t,{DW:()=>a,TI:()=>s,oI:()=>r})},64937:(e,t,n)=>{let r,a;async function s(e,t={}){let{getDocument:n}=await o();return await n({data:e,isEvalSupported:!1,useSystemFonts:!0,...t}).promise}async function o(){return r||await i(),r}async function i(e,{reload:t=!1}={}){if(!r||t){if(e)try{r=await u(e());return}catch(e){throw Error(`PDF.js could not be resolved: ${e}`)}try{r=await n.e(602).then(n.bind(n,48602))}catch(e){throw Error(`Serverless PDF.js bundle could not be resolved: ${e}`)}}}async function u(e){let t=await e;return t.default||t}n.d(t,{C:()=>d}),globalThis.process?.release?.name;class l{#e=!1;constructor({enableHWA:e=!1}={}){this.#e=e}create(e,t){let n=this._createCanvas(e,t);return{canvas:n,context:n.getContext("2d",{willReadFrequently:!this.#e})}}reset({canvas:e},t,n){if(!e)throw Error("Canvas is not specified");e.width=t,e.height=n}destroy(e){if(!e.canvas)throw Error("Canvas is not specified");e.canvas.width=0,e.canvas.height=0,e.canvas=void 0,e.context=void 0}_createCanvas(e,t){throw Error("Not implemented")}}async function c(e,t={}){let{mergePages:n=!1}=t,r="object"==typeof e&&null!==e&&"_pdfInfo"in e?e:await s(e),a=await Promise.all(Array.from({length:r.numPages},(e,t)=>g(r,t+1)));return{totalPages:r.numPages,text:n?a.join("\n").replace(/\s+/g," "):a}}async function g(e,t){let n=await e.getPage(t);return(await n.getTextContent()).items.filter(e=>null!=e.str).map(e=>e.str+(e.hasEOL?"\n":"")).join("")}let h=async(...e)=>(await i(),await c(...e));async function d(e){try{console.log("\uD83D\uDCE5 Fetching PDF from:",e);let t=await fetch(e);if(!t.ok)throw Error(`Failed to fetch PDF: ${t.status}`);let n=await t.arrayBuffer();console.log("\uD83D\uDCE6 PDF size:",n.byteLength,"bytes");let{text:r,totalPages:a}=await h(n,{mergePages:!0}),s=r.trim();if(console.log("\uD83D\uDCC4 PDF extraction successful:",{pages:a||0,textLength:s.length,preview:s.substring(0,150)+"..."}),s.length<50)throw console.warn("⚠️ Extracted text too short:",s.length,"chars"),Error("PDF enth\xe4lt zu wenig Text (m\xf6glicherweise nur Bilder). Bitte verwenden Sie ein PDF mit Text-Ebene.");return s}catch(e){throw console.error("❌ PDF extraction error:",{message:e.message,stack:e.stack,name:e.name}),Error(`PDF-Extraktion fehlgeschlagen: ${e.message}`)}}}};var t=require("../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),r=t.X(0,[948,972],()=>n(29773));module.exports=r})();