(()=>{var e={};e.id=3565,e.ids=[3565],e.modules={72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{"use strict";e.exports=require("assert")},78893:e=>{"use strict";e.exports=require("buffer")},84770:e=>{"use strict";e.exports=require("crypto")},17702:e=>{"use strict";e.exports=require("events")},92048:e=>{"use strict";e.exports=require("fs")},32615:e=>{"use strict";e.exports=require("http")},35240:e=>{"use strict";e.exports=require("https")},98216:e=>{"use strict";e.exports=require("net")},19801:e=>{"use strict";e.exports=require("os")},55315:e=>{"use strict";e.exports=require("path")},86624:e=>{"use strict";e.exports=require("querystring")},76162:e=>{"use strict";e.exports=require("stream")},82452:e=>{"use strict";e.exports=require("tls")},17360:e=>{"use strict";e.exports=require("url")},21764:e=>{"use strict";e.exports=require("util")},71568:e=>{"use strict";e.exports=require("zlib")},93739:()=>{},94121:(e,r,t)=>{"use strict";t.r(r),t.d(r,{originalPathname:()=>g,patchFetch:()=>y,requestAsyncStorage:()=>h,routeModule:()=>d,serverHooks:()=>x,staticGenerationAsyncStorage:()=>m});var s={};t.r(s),t.d(s,{POST:()=>p});var a=t(49303),i=t(88716),n=t(60670),o=t(87070),c=t(75571),u=t(95456),l=t(65471);async function p(e){try{await (0,c.getServerSession)(u.L);let{service:r,contractId:t,email:s}=await e.json();if(!["analyze","generate"].includes(r))return o.NextResponse.json({error:"Ung\xfcltiger Service-Typ"},{status:400});let a={analyze:{name:"Service 1: Mietvertrag-Analyse",description:"KI-Analyse mit Ersparnis-Berechnung",price:9},generate:{name:"Service 2: Brief-Generierung",description:"Rechtssicheres Herabsetzungsbegehren als PDF",price:49}}[r],i="http://localhost:3000",n=process.env.PAYREXX_INSTANCE,p=process.env.PAYREXX_API_SECRET;if(!n||!p)return console.warn("⚠️ Payrexx not configured, returning test mode URL"),o.NextResponse.json({url:`${i}/payment/success?session_id=TEST_MODE&service=${r}`,sessionId:"TEST_MODE",testMode:!0,message:"Payrexx not configured. Using test mode."});let d=await (0,l.oB)({amount:(0,l.Y6)(a.price),currency:"CHF",purpose:a.name,successRedirectUrl:`${i}/payment/success?service=${r}${t?`&contractId=${t}`:""}`,failedRedirectUrl:`${i}/payment/cancel?service=${r}`,cancelRedirectUrl:`${i}/payment/cancel?service=${r}`,referenceId:t?`contract_${t}`:`${r}_${Date.now()}`,preAuthorization:!1,fields:s?[{title:"E-Mail",value:s,mandatory:!0}]:void 0});return console.log("✅ Payrexx gateway created:",{id:d.id,hash:d.hash,service:r,amount:a.price}),o.NextResponse.json({url:d.link,sessionId:d.hash,gatewayId:d.id})}catch(e){return console.error("❌ Checkout error:",e),o.NextResponse.json({error:"Fehler beim Erstellen der Checkout-Session: "+e.message,details:e.stack},{status:500})}}let d=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/create-checkout/route",pathname:"/api/create-checkout",filename:"route",bundlePath:"app/api/create-checkout/route"},resolvedPagePath:"D:\\STTH\\2026 KI\\mietcheck\\src\\app\\api\\create-checkout\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:h,staticGenerationAsyncStorage:m,serverHooks:x}=d,g="/api/create-checkout/route";function y(){return(0,n.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:m})}},53797:(e,r)=>{"use strict";r.Z=function(e){return{id:"credentials",name:"Credentials",type:"credentials",credentials:{},authorize:()=>null,options:e}}},95456:(e,r,t)=>{"use strict";t.d(r,{L:()=>o});var s=t(53797),a=t(42023),i=t.n(a),n=t(86923);let o={providers:[(0,s.Z)({name:"Credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;try{let r=(await (0,n.i6)`
            SELECT id, email, password_hash, name
            FROM users
            WHERE email = ${e.email.toLowerCase().trim()}
          `).rows[0];if(!r||!await i().compare(e.password,r.password_hash))return null;return console.log("✅ Login successful for:",r.email),{id:r.id.toString(),email:r.email,name:r.name}}catch(e){return console.error("❌ Auth error:",e),null}}})],pages:{signIn:"/login",signOut:"/login",error:"/login"},callbacks:{jwt:async({token:e,user:r})=>(r&&(e.id=r.id),e),session:async({session:e,token:r})=>(e.user&&(e.user.id=r.id),e)},session:{strategy:"jwt",maxAge:2592e3},secret:process.env.NEXTAUTH_SECRET}},65471:(e,r,t)=>{"use strict";function s(){let e=process.env.PAYREXX_INSTANCE,r=process.env.PAYREXX_API_SECRET;if(!e||!r)throw Error("Payrexx configuration missing. Set PAYREXX_INSTANCE and PAYREXX_API_SECRET in environment variables.");return{instance:e,apiSecret:r}}function a(e,r){return t(84770).createHmac("sha256",r).update(e).digest("base64")}async function i(e){let r=s(),t={amount:e.amount,currency:e.currency,purpose:e.purpose,successRedirectUrl:e.successRedirectUrl,failedRedirectUrl:e.failedRedirectUrl,cancelRedirectUrl:e.cancelRedirectUrl,preAuthorization:e.preAuthorization||!1};e.referenceId&&(t.referenceId=e.referenceId),e.vatRate&&(t.vatRate=e.vatRate),e.fields&&e.fields.length>0&&(t.fields=e.fields);let i=Object.keys(t).sort().map(e=>{let r=t[e];return"object"==typeof r?`${e}=${encodeURIComponent(JSON.stringify(r))}`:`${e}=${encodeURIComponent(r)}`}).join("&"),n=a(i,r.apiSecret),o=`https://api.payrexx.com/v1.0/Gateway/?instance=${r.instance}`,c=await fetch(o,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","API-KEY":n},body:i});if(!c.ok){let e=await c.text();throw Error(`Payrexx API Error ${c.status}: ${e}`)}let u=await c.json();if("success"!==u.status)throw Error(`Payrexx Error: ${u.message||"Unknown error"}`);return{id:u.data[0].id,hash:u.data[0].hash,link:u.data[0].link}}async function n(e){let r=s(),t=a(`transactionId=${e}`,r.apiSecret),i=`https://api.payrexx.com/v1.0/Transaction/${e}/?instance=${r.instance}`,n=await fetch(i,{method:"GET",headers:{"API-KEY":t}});if(!n.ok){let e=await n.text();throw Error(`Payrexx API Error ${n.status}: ${e}`)}let o=await n.json();if("success"!==o.status)throw Error(`Payrexx Error: ${o.message||"Unknown error"}`);return o.data[0]}function o(e,r,s){return r===t(84770).createHmac("sha256",s).update(e).digest("base64")}function c(e){return Math.round(100*e)}function u(e){return e/100}t.d(r,{Y6:()=>c,fo:()=>n,kM:()=>u,oB:()=>i,po:()=>o})}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[8948,1615,5972,6923,5571,2023],()=>t(94121));module.exports=s})();